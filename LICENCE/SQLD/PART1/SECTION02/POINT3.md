### POINT3 : 반정규화

> 반정규화
> 

<img width="426" alt="스크린샷 2022-02-18 오후 3 15 18" src="https://user-images.githubusercontent.com/81155572/154628353-af5a4289-4067-4eed-80e1-986578f5e40f.png">


- 반정규화는 DB 성능 향상을 위해, **데이터 중복을 허용하고 조인을 줄이는** 방법이다.
- 조회select 속도는 향상되지만 데이터 모델의 유연성은 낮아진다.

> 반정규화를 수행하는 경우
> 
- 정규화에 충실하면 종속성, 활용성은 향상되지만 수행 속도가 느려지는 경우
- 다량의 범위를 자주 처리해야 하는 경우
- 특정 범위의 데이터만 자주 처리하는 경우
- 요약/집계정보가 자주 요구되는 경우
- 반정규화 정보에 대한 재현의 적시성으로 판단
    - 여러 테이블에 대해 다량의 조인이 필요한 경우, 적시성 확보를 위해 반정규화 한다.

> 반정규화 절차
> 

<img width="446" alt="스크린샷 2022-02-18 오후 3 15 29" src="https://user-images.githubusercontent.com/81155572/154628377-009ee5b5-753a-4379-ba9c-add66225170a.png">


1. 반정규화 대상 조사
- **범위처리빈도수 조사, 대량의 범위 처리 조사, 통계성 프로세스 조사, 테이블 조인 개수**를 통해 대상을 조사한다.
2. 다른 방법으로 유도 조사
- 반정규화 외 다른 방법(클러스터링, 뷰, 인덱스 튜닝, **파티셔닝, 응용 어플의 로직 등)이 있는지 조사한다.
    - 클러스터링 : 클러스터링 인덱스는 인덕스 정보를 저장할 때 물리적으로 정렬해 저장하는 방법으로, 인접 블록을 연속적으로 읽기 때문에 성능이 향상된다.
    - 파티셔닝 : 논리적으로는 한 테이블이지만 여러 데이터 파일에 분산되어 저장하는 것. 데이터 조회 시 액세스 범위가 줄고, 데이터가 분할되어 있어 I/O성능이 향상된다. 각 파티션을 독립적으로 백업/복구할 수 있다.
        - 데이터값의 범위를 기준으로 하는 Range 파티셔닝
        - 특정 값을 지정하는 List 파티셔닝
        - 해시함수를 적용하는 Hash 파티셔닝
        - 범위와 해시를 복합적으로 사용하는 Compoiste 파티셔닝
3. 반정규화 수행

> 반정규화 기법
> 
1. **테이블 반정규화 : 테이블 병합/분할/추가**
- 테이블 병합

| 기법 | 내용 |
| --- | --- |
| 1:1 관계 테이블 병합 | 1:1 관계를 통합하여 성능 향상 |
| 1:M 관계 테이블 병합 | 1:M 관계를 통합하여 성능 향상 |
| 수퍼/서브 타입 테이블 병합 | 수퍼/서브(부모-자식) 관계를 통합하여 성능 향상 |

**수퍼/서브타입 변환 방법 : 데이터 양&트랜잭션 유형에 따라**

<img width="455" alt="스크린샷 2022-02-18 오후 3 15 49" src="https://user-images.githubusercontent.com/81155572/154628413-d4de6e0f-cef4-4d4f-aede-e2e95bf9e4e2.png">


- 테이블 분할
    
    <img width="414" alt="스크린샷 2022-02-18 오후 3 16 01" src="https://user-images.githubusercontent.com/81155572/154628438-25b7590b-ac02-4412-a9d1-8a24b256c1ca.png">

    

| 기법 | 내용 |
| --- | --- |
| 수직분할 | 칼럼 단위 테이블을, I/O 분산처리를 위해 테이블을 1:1로 분리하여 성능 향상 트랜잭션이 처리되는 유형을 파악하는 것이 선행되어야 한다 |
| 수평분할 | 로우 단위로 집중 발생되는 트랜잭션을 분석해 I/O 및 데이터 접근성의 효율성을 높여 성능을 향상하기 위해 특정 값에 따라 로우 단위로 테이블을 쪼갠다. |

- 테이블 추가

| 기법 | 내용 |
| --- | --- |
| 중복 테이블 추가 | 다른 업무거나 서버가 다른 경우 동일 테이블 구조를 중복하여 원격 조인을 제거하여 성능을 향상 |
| 통계 테이블 추가 | SUM, AVG 등을 미리 수행하여 계산해 둠으로써 조회 시 성능을 향상 |
| 이력 테이블 추가 | 이력 테이블 중 마스터 테이블에 존재하는 레코드를 중복하여 성능 향상 |
| 부분 테이블 추가 | 한 테이블의 전체 칼럼 중 자주 이용하는 집중화된 칼럼들의 I/O를 줄이기 위해 해당 칼럼을 모아놓은 별도의 테이블을 생성 |

2. **칼럼 반정규화**

| 기법 | 내용 |
| --- | --- |
| 중복 칼럼 추가 | 조인을 감소시키기 위해 칼럼 중복하기 |
| 파생 칼럼 추가 | 계산에 의해 발생되는 성능 저하를 예방하기 위해 미리 값을 계산한 칼럼 추가 |
| 이력 테이블 칼럼 추가 | 불특정 조회로 인한 성능 저하 예방을 위해 이력 테이블에 기능성 칼럼(최근 값 여부, 시작과 종료일자 등) 추가 |
| PK에 의한 칼럼 추가 | 단일 PK 내에서 특정 값을 조회하는 경우 생기는 성능 저하를 예방하기 위해 이미 존재하는 PK 데이터를 일반 속성으로 포함하는 칼럼을 추가 |
| 응용 시스템 오작동을 위한 칼럼 추가 | 업무적으로는 의미가 없지만 사용자의 잘못된 데이터 처리로 원래 값 복구를 원하는 경우, 이전 데이터를 임시적으로 중복하여 보관하는 칼럼 추가 |

3. **관계 반정규화**

| 기법 | 내용 |
| --- | --- |
| 중복 관계 추가 | 데이터 처리를 위한 여러 조인이 발생시키는 성능 저하 예방을 위해 추가적인 관계를 맺는 것 |

> Row Chaining과 Row Migration
> 
- Row Chaining 로우체이닝
    - 로우에 데이터가 insert 후 delete 되어 한 행이 삭제되고 해당 블록에 빈 공간이 생겼을 때 새로운 데이터가 입력된다고 가정하자
    - 새로운 데이터가 입력될 때 처음에 빈 공간이 있는 블록에 입력되고 그 공간이 부족할 때 새로운 블록에 나머지 데이터를 입력하는 것을 로우 체이닝이라고 한다.
    - 로우 길이가 너무 길어서 데이터 블록 하나에 데이터가 모두 저장되지 않고, 두 개 이상의 블록에 걸쳐 한 로우가 저장되어 있는 형태이다.
- Row Migration 로우마이그래이션
    - 행에 입력될 수 있는 데이터 영역에 데이터가 모두 입력되어 저장 공간이 부족한 경우에서 기존 데이터의 변경 작접이 일어난다고 가정하자.
    - 변경 작업에 의해 공간이 더 필요한데 저장 공간이 없을 경우 새로운 블록으로 이동시켜 변경 작업을 수행하는 것이 로우 마이그레이션이다.
    - 데이터 블록에서 수정이 발생하면 수정된 데이터를 해당 데이터 블록에 저장하지 못하고 다른 블록의 빈 공간을 찾아 저장하는 방식이다.
